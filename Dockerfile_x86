# ------------------------------------------------------------
# Base: Miniconda (conda + Python)
# ------------------------------------------------------------
FROM continuumio/miniconda3:latest

# Avoid interactive prompts
ENV DEBIAN_FRONTEND=noninteractive

# ------------------------------------------------------------
# Install system dependencies
# ------------------------------------------------------------
RUN apt-get update && apt-get install -y --no-install-recommends \
    wget \
    curl \
    git \
    tini \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# ------------------------------------------------------------
# Install Quarto CLI
# ------------------------------------------------------------
RUN wget https://quarto.org/download/latest/quarto-linux-amd64.deb \
    && dpkg -i quarto-linux-amd64.deb \
    && rm quarto-linux-amd64.deb

# ------------------------------------------------------------
# Copy environment.yml into container
# ------------------------------------------------------------
COPY mlmiin26.yml /tmp/mlmiin26.yml

# ------------------------------------------------------------
# Create conda environment
# ------------------------------------------------------------
RUN conda env create -f /tmp/mlmiin26.yml && conda clean -afy

# Set environment
ENV CONDA_DEFAULT_ENV=mlmiin
ENV PATH=/opt/conda/envs/mlmiin/bin:$PATH

# ------------------------------------------------------------
# JupyterLab config (optional)
# ------------------------------------------------------------
EXPOSE 8888

# This ensures ctrl+C works cleanly
ENTRYPOINT ["tini", "--"]

# Default command: start JupyterLab
CMD ["bash", "-c", "jupyter lab --ip=0.0.0.0 --no-browser --allow-root"]
